<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Recursive and Blocks Generator</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      border: 0;
      background-color: #333;

      height: 100vh;
      font-size: small;
    }

    #nft-display {
      width: calc(100vw - 400px);
      height: 100%;

      background-color: 666;
      padding: 0px;
      border: 0px;
      margin: 0px;

      overflow: hidden;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: 0px;
      padding: 0px;
      margin: 0px;
    }

    #settings-panel {
      width: 400px;
      height: 100%;
      background-color: #fff;
      right: 0;
      top: 0;

      position: absolute;
      box-shadow: #333 0px 0px 10px 0px;

      overflow-y: scroll;

      padding: 30px;
    }

    .override-feature {
      padding: 12px;
      border-radius: 6px;
      border: 2px solid #111;
      background-color: #333;
      color: #FFF;
    }

    .colorDisplayer {
      width: 100px;
      height: 24px;
      border: 1px solid #666;
      border-radius: 6px;
      background-color: #A00;
      text-align: center;
    }
  </style>
  <script id="fxhash-snippet">
    //---- do not edit the following code (you can indent as you wish)
    let search = new URLSearchParams(window.location.search)
    let alphabet = "123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"
    var fxhash = search.get('fxhash') || "oo" + Array(49).fill(0).map(_ => alphabet[(Math.random() * alphabet.length) | 0]).join('')
    let b58dec = str => [...str].reduce((p, c) => p * alphabet.length + alphabet.indexOf(c) | 0, 0)
    let fxhashTrunc = fxhash.slice(2)
    let regex = new RegExp(".{" + ((fxhash.length / 4) | 0) + "}", 'g')
    let hashes = fxhashTrunc.match(regex).map(h => b58dec(h))
    let sfc32 = (a, b, c, d) => {
      return () => {
        a |= 0; b |= 0; c |= 0; d |= 0
        var t = (a + b | 0) + d | 0
        d = d + 1 | 0
        a = b ^ b >>> 9
        b = c + (c << 3) | 0
        c = c << 21 | c >>> 11
        c = c + t | 0
        return (t >>> 0) / 4294967296
      }
    }
    var fxrand = sfc32(...hashes)
    // true if preview mode active, false otherwise
    // you can append preview=1 to the URL to simulate preview active
    var isFxpreview = search.get('preview') === "1"
    // call this method to trigger the preview
    function fxpreview() {
      console.log("fxhash: TRIGGER PREVIEW")
    }
    //---- /do not edit the following code
  </script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
    crossorigin="anonymous"></script>

  <!-- jquery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
  <div id="nft-display">
    <iframe id="nft-iframe"></iframe>
  </div>

  <script>

    let userOverrideSettings = {};
    let hasData = false;

    $(window).on('load', function () {
      customLoop();
    });

    async function customLoop() {
      while (true) {
        getRemoteData();

        await sleep(6000);

        if (hasData) {
          RegenerateImg();
          await sleep(10000);
        }
      }
    }

    async function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function getRemoteData() {
      let url = "../api/";
      let data = {
        "action": "get_unviewed"
      };

      console.log("get remote data");

      $.post(url, data, function (response) {
        console.log(response);

        let datas = JSON.parse(response);

        for (let i = 0; i < datas.length; i++) {
          let id = datas[i].id;
          let user_id = datas[i].user_id;
          let ip_address = datas[i].ip_address;
          let timestamp = datas[i].time_stamp;

          let feature_data = JSON.parse(datas[i].data.replace(/\/+$/, ''));

          console.log(`id: ${id}, user_id: ${user_id}, ip_address: ${ip_address}, timestamp: ${timestamp}`);
          console.log(feature_data);

          userOverrideSettings = feature_data;
          hasData = true;
        }
      });
    }

    function randomHashSeed() {
      let newSeed = "oo" + Array(49).fill(0).map(_ => alphabet[(Math.random() * alphabet.length) | 0]).join('')
      return newSeed;
    }

    function RegenerateImg() {
      hasData = false;
      let currentHash = $('#fxhashSeedInput').val();
      let newUrl = `../artifact/index.html?fxhash=${currentHash}`;

      $('#nft-iframe').attr('src', newUrl);
    }

    function iFrameReady() {
      // call override funciton in iframe
      let iframe = document.getElementById('nft-iframe');
      let iframeWindow = iframe.contentWindow;
      iframeWindow.OverrideFeatures(GetOverrideSettings());
    }

    function GetOverrideSettings() {
      // "background_color": setDatas['override-set-background_color'].pickedIndex,
      // "layout": setDatas['override-set-layout'].pickedIndex,
      // "main_color": setDatas['override-set-main_color'].pickedIndex,
      // "color_type": setDatas['override-set-color_type'].pickedIndex,
      // "triangle_chance": setDatas['override-set-triangle_chance'].pickedIndex,
      // "paper_texture": setDatas['override-set-paper_texture'].pickedIndex,
      let resultSettings = {};

      resultSettings.seed = randomHashSeed();
      resultSettings.inputWidth = 1920;
      resultSettings.inputHeight = 1080;
      resultSettings.inputDensity = 1;

      if (userOverrideSettings["background_color"] == 1) {
        resultSettings.paperColor = "#333333";
      }
      else if (userOverrideSettings["background_color"] == 2) {
        resultSettings.paperColor = "#DDDDDD";
      }

      if (userOverrideSettings["main_color"] != 0) {
        resultSettings.mainHue = (parseInt(userOverrideSettings["main_color"]) - 1) * 50;
      }

      if (userOverrideSettings["color_type"] == 1)
        resultSettings.colorType = 1;
      else if (userOverrideSettings["color_type"] == 2)
        resultSettings.colorType = 4;
      else if (userOverrideSettings["color_type"] == 3)
        resultSettings.colorType = 2;
      else if (userOverrideSettings["color_type"] == 4)
        resultSettings.colorType = 3;

      if (userOverrideSettings["triangle_chance"] == 1)
        resultSettings.triangleChance = 0.0;
      else if (userOverrideSettings["triangle_chance"] == 2)
        resultSettings.triangleChance = 0.03;
      else if (userOverrideSettings["triangle_chance"] == 3)
        resultSettings.triangleChance = 0.12;
      else if (userOverrideSettings["triangle_chance"] == 4)
        resultSettings.triangleChance = 0.32;

      if (userOverrideSettings["paper_texture"] == 1) {
        resultSettings.textureEnabled = false;
      }
      else if (userOverrideSettings["paper_texture"] == 2) {
        resultSettings.textureEnabled = true;
        overrideSettings.textureDirection = 0;
      }
      else if (userOverrideSettings["paper_texture"] == 3) {
        resultSettings.textureEnabled = true;
        overrideSettings.textureDirection = 1;
      }

      return resultSettings;
    }

    function SaveImage() {
      // call save function in iframe
      let iframe = document.getElementById('nft-iframe');
      let iframeWindow = iframe.contentWindow;
      iframeWindow.SaveImage();
    }

    function toggleOverrideSet(toggleButton, setIndex) {
      let targetSet = $(`#override-set-${setIndex}`);
      let buttonStatus = $(toggleButton).is(':checked');

      if (buttonStatus) {
        targetSet.show();
      }
      else {
        targetSet.hide();
      }
    }
  </script>

</body>

</html>